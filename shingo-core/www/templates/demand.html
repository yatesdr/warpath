{{define "content"}}
<div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
    <h1>Demand</h1>
    <div style="display:flex;gap:.5rem;">
      {{if .Authenticated}}
      <button class="btn btn-primary" onclick="showAddRow()">+ Add Material</button>
      <button class="btn" onclick="applyAll()">Apply All</button>
      <button class="btn" onclick="clearAllProduced()">Zero Counts</button>
      {{end}}
    </div>
  </div>

  <table class="table" id="demand-table">
    <thead>
      <tr>
        <th>Cat-ID</th>
        <th>Description</th>
        <th class="col-num">Demand</th>
        <th class="col-num">Produced</th>
        <th class="col-num">Remaining</th>
        {{if .Authenticated}}<th style="width:1%;white-space:nowrap;">Actions</th>{{end}}
      </tr>
    </thead>
    <tbody id="demand-body">
      {{range .Demands}}
      <tr data-id="{{.ID}}" data-cat="{{.CatID}}" data-orig-desc="{{.Description}}" data-orig-demand="{{pct .DemandQty}}" data-orig-produced="{{pct .ProducedQty}}">
        <td>{{.CatID}}</td>
        <td>{{.Description}}</td>
        <td class="cell-demand cell-editable">
          <span class="cell-val" onclick="{{if $.Authenticated}}startEdit(this,'demand_qty'){{end}}">{{pct .DemandQty}}</span>
          <input type="text" inputmode="decimal" class="cell-input cell-input-num" name="demand_qty" value="{{pct .DemandQty}}" onblur="stopEdit(this,'demand_qty')" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value=this.closest('tr').dataset.origDemand;this.blur();}">
        </td>
        <td class="cell-produced cell-editable">
          <span class="cell-val" onclick="{{if $.Authenticated}}startEdit(this,'produced_qty'){{end}}">{{pct .ProducedQty}}</span>
          <input type="text" inputmode="decimal" class="cell-input cell-input-num" name="produced_qty" value="{{pct .ProducedQty}}" onblur="stopEditProduced(this)" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value=this.closest('tr').dataset.origProduced;this.blur();}">
        </td>
        <td class="cell-remaining">{{pct .Remaining}}</td>
        {{if $.Authenticated}}
        <td style="white-space:nowrap;">
          <button class="icon-btn" onclick="applyRow(this)" title="Save changes"><svg width="15" height="15" viewBox="0 0 16 16" fill="currentColor"><path d="M13.5 2l-7.5 7.5L2.5 6 1 7.5l5 5 9-9z"/></svg></button>
          <button class="icon-btn" onclick="viewLog({{.ID}})" title="Production log"><svg width="15" height="15" viewBox="0 0 16 16" fill="currentColor"><path d="M2 3h12v1H2zm0 3h12v1H2zm0 3h10v1H2zm0 3h8v1H2z"/></svg></button>
          <button class="icon-btn" onclick="openEditModal(this)" title="Edit"><svg width="15" height="15" viewBox="0 0 16 16" fill="currentColor"><path d="M11.5 1.1a1.5 1.5 0 012.1 0l1.3 1.3a1.5 1.5 0 010 2.1L5.6 13.8l-4 1a.5.5 0 01-.6-.6l1-4L11.5 1.1zm1.4.7a.5.5 0 00-.7 0L3.5 10.5l-.7 2.8 2.8-.7L14.3 3.9a.5.5 0 000-.7l-1.3-1.3z"/></svg></button>
          <button class="icon-btn icon-btn-danger" onclick="deleteRow(this)" title="Delete"><svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><path d="M3.5 3.5l9 9m0-9l-9 9" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg></button>
        </td>
        {{end}}
      </tr>
      {{else}}
      <tr id="empty-row"><td colspan="{{if .Authenticated}}6{{else}}5{{end}}" style="text-align:center;color:#888;">No demands configured</td></tr>
      {{end}}
    </tbody>
  </table>
</div>

<!-- Add Material Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal" style="max-width:400px">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Add Material</h2>
      <button class="modal-close" onclick="hideModal('add-modal')">&times;</button>
    </div>
    <div style="margin-bottom:.75rem;">
      <label class="demand-label">Cat-ID</label>
      <input type="text" id="add-cat-id" class="demand-form-input" placeholder="e.g. ABC-123">
    </div>
    <div style="margin-bottom:.75rem;">
      <label class="demand-label">Description</label>
      <input type="text" id="add-description" class="demand-form-input" placeholder="Part description">
    </div>
    <div style="margin-bottom:1rem;">
      <label class="demand-label">Demand Qty</label>
      <input type="number" id="add-demand-qty" class="demand-form-input" value="0" step="any" min="0">
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;">
      <button class="btn" onclick="hideModal('add-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="addMaterial()">Add</button>
    </div>
  </div>
</div>

<!-- Edit Material Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal" style="max-width:400px">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Edit Material</h2>
      <button class="modal-close" onclick="hideModal('edit-modal')">&times;</button>
    </div>
    <input type="hidden" id="edit-id">
    <div style="margin-bottom:.75rem;">
      <label class="demand-label">Cat-ID</label>
      <input type="text" id="edit-cat-id" class="demand-form-input">
    </div>
    <div style="margin-bottom:1rem;">
      <label class="demand-label">Description</label>
      <input type="text" id="edit-description" class="demand-form-input">
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;">
      <button class="btn" onclick="hideModal('edit-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- Production Log Modal -->
<div class="modal-overlay" id="log-modal">
  <div class="modal" style="max-width:600px">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Production Log: <span id="log-cat-id"></span></h2>
      <button class="modal-close" onclick="hideModal('log-modal')">&times;</button>
    </div>
    <div id="log-body" style="max-height:400px;overflow-y:auto;">
      <p style="color:#888;">Loading...</p>
    </div>
    <div style="text-align:right;margin-top:1rem;">
      <button class="btn" onclick="hideModal('log-modal')">Close</button>
    </div>
  </div>
</div>

<style>
.cell-editable {
  position: relative;
}
.cell-val {
  cursor: default;
  display: inline-block;
  min-width: 2rem;
  padding-bottom: 1px;
}
{{if .Authenticated}}
.cell-editable .cell-val {
  border-bottom: 1px dashed #adb5bd;
  cursor: pointer;
}
.cell-editable .cell-val:hover {
  border-bottom-color: #7c3aed;
}
{{end}}
.col-num,
.cell-demand, .cell-produced, .cell-remaining {
  text-align: center;
  width: 7rem;
}
.cell-input {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border: none;
  border-bottom: 2px solid #7c3aed;
  padding: 0.6rem 0.75rem;
  font-size: inherit;
  font-family: inherit;
  background: rgba(255,255,255,0.97);
  width: 100%;
  box-sizing: border-box;
  outline: none;
  opacity: 0;
  pointer-events: none;
  z-index: 1;
}
.cell-input.editing {
  opacity: 1;
  pointer-events: auto;
}
.cell-input-num { text-align: center; }
.cell-dirty .cell-val { color: #dc3545; font-weight: 700; }
.icon-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.25rem;
  color: #495057;
  border-radius: 4px;
  vertical-align: middle;
}
.icon-btn:hover { background: #e9ecef; }
.icon-btn-danger:hover { background: #f8d7da; color: #dc3545; }
.btn-danger { background: #dc3545; color: #fff; border-color: #dc3545; }
.btn-danger:hover { background: #c82333; }
.demand-form-input { width:100%; padding:.4rem .5rem; border:1px solid #ced4da; border-radius:4px; font-size:inherit; box-sizing:border-box; }
.demand-label { display:block; margin-bottom:.25rem; font-weight:600; }
</style>

<script>
function showModal(id) { document.getElementById(id).classList.add('active'); }
function hideModal(id) { document.getElementById(id).classList.remove('active'); }

// --- Click-to-edit ---
function startEdit(span, field) {
  var td = span.parentElement;
  var input = td.querySelector('.cell-input');
  input.classList.add('editing');
  input.focus();
  input.select();
}

function stopEdit(input, field) {
  var td = input.parentElement;
  var span = td.querySelector('.cell-val');
  var tr = input.closest('tr');
  span.textContent = input.value;
  input.classList.remove('editing');
  checkDirty(tr);
}

function stopEditProduced(input) {
  var td = input.parentElement;
  var span = td.querySelector('.cell-val');
  var tr = input.closest('tr');
  span.textContent = input.value;
  input.classList.remove('editing');
  checkDirty(tr);
}

function checkDirty(tr) {
  var demandInput = tr.querySelector('[name="demand_qty"]');
  var producedInput = tr.querySelector('[name="produced_qty"]');
  var demandDirty = (parseFloat(demandInput.value) || 0) !== (parseFloat(tr.dataset.origDemand) || 0);
  var producedDirty = (parseFloat(producedInput.value) || 0) !== (parseFloat(tr.dataset.origProduced) || 0);
  demandInput.parentElement.classList.toggle('cell-dirty', demandDirty);
  producedInput.parentElement.classList.toggle('cell-dirty', producedDirty);
}

// --- API calls ---
function showAddRow() {
  document.getElementById('add-cat-id').value = '';
  document.getElementById('add-description').value = '';
  document.getElementById('add-demand-qty').value = '0';
  showModal('add-modal');
}

async function addMaterial() {
  var catId = document.getElementById('add-cat-id').value.trim();
  if (!catId) { alert('Cat-ID is required'); return; }
  var body = {
    cat_id: catId,
    description: document.getElementById('add-description').value,
    demand_qty: parseFloat(document.getElementById('add-demand-qty').value) || 0
  };
  try {
    var res = await fetch('/api/demands', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    var data = await res.json();
    if (!res.ok) { alert(data.error || 'Error creating demand'); return; }
    hideModal('add-modal');
    location.reload();
  } catch(e) { alert('Error: ' + e); }
}

function openEditModal(btn) {
  var tr = btn.closest('tr');
  document.getElementById('edit-id').value = tr.dataset.id;
  document.getElementById('edit-cat-id').value = tr.dataset.cat;
  document.getElementById('edit-description').value = tr.dataset.origDesc;
  showModal('edit-modal');
}

async function saveEdit() {
  var id = document.getElementById('edit-id').value;
  var tr = document.querySelector('tr[data-id="' + id + '"]');
  var body = {
    cat_id: document.getElementById('edit-cat-id').value.trim(),
    description: document.getElementById('edit-description').value,
    demand_qty: parseFloat(tr.querySelector('[name="demand_qty"]').value) || 0,
    produced_qty: parseFloat(tr.querySelector('[name="produced_qty"]').value) || 0
  };
  if (!body.cat_id) { alert('Cat-ID is required'); return; }
  try {
    var res = await fetch('/api/demands/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if (!res.ok) { var err = await res.json(); alert(err.error || 'Error'); return; }
    hideModal('edit-modal');
    location.reload();
  } catch(e) { alert('Error: ' + e); }
}

function getRowData(tr) {
  return {
    id: parseInt(tr.dataset.id),
    cat_id: tr.dataset.cat,
    description: tr.dataset.origDesc,
    demand_qty: parseFloat(tr.querySelector('[name="demand_qty"]').value) || 0,
    produced_qty: parseFloat(tr.querySelector('[name="produced_qty"]').value) || 0
  };
}

async function applyRow(btn) {
  var tr = btn.closest('tr');
  var d = getRowData(tr);
  try {
    var res = await fetch('/api/demands/' + d.id, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cat_id:d.cat_id, description:d.description, demand_qty:d.demand_qty, produced_qty:d.produced_qty}) });
    if (!res.ok) { var err = await res.json(); alert(err.error || 'Error'); return; }
    location.reload();
  } catch(e) { alert('Error: ' + e); }
}

async function deleteRow(btn) {
  if (!confirm('Delete this tracked material?')) return;
  var tr = btn.closest('tr');
  var id = tr.dataset.id;
  try {
    var res = await fetch('/api/demands/' + id, { method:'DELETE' });
    if (!res.ok) { var err = await res.json(); alert(err.error || 'Error'); return; }
    location.reload();
  } catch(e) { alert('Error: ' + e); }
}

async function applyAll() {
  if (!confirm('Apply all changes?')) return;
  var rows = document.querySelectorAll('#demand-body tr[data-id]');
  try {
    for (var i = 0; i < rows.length; i++) {
      var d = getRowData(rows[i]);
      var res = await fetch('/api/demands/' + d.id, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cat_id:d.cat_id, description:d.description, demand_qty:d.demand_qty, produced_qty:d.produced_qty}) });
      if (!res.ok) { var err = await res.json(); alert(err.error || 'Error'); return; }
    }
    location.reload();
  } catch(e) { alert('Error: ' + e); }
}

async function clearAllProduced() {
  if (!confirm('Zero all produced counts? This will not change demand quantities.')) return;
  try {
    var res = await fetch('/api/demands/clear-all', { method:'POST' });
    if (!res.ok) { var err = await res.json(); alert(err.error || 'Error'); return; }
    location.reload();
  } catch(e) { alert('Error: ' + e); }
}

async function viewLog(id) {
  var tr = document.querySelector('tr[data-id="' + id + '"]');
  var catId = tr ? tr.dataset.cat : '';
  document.getElementById('log-cat-id').textContent = catId;
  document.getElementById('log-body').innerHTML = '<p style="color:#888;">Loading...</p>';
  showModal('log-modal');
  try {
    var res = await fetch('/api/demands/' + id + '/log');
    var entries = await res.json();
    if (!entries || entries.length === 0) {
      document.getElementById('log-body').innerHTML = '<p style="color:#888;">No production reports yet.</p>';
      return;
    }
    var html = '<table class="table"><thead><tr><th>Station</th><th>Quantity</th><th>Reported At</th></tr></thead><tbody>';
    for (var i = 0; i < entries.length; i++) {
      var e = entries[i];
      html += '<tr><td>' + esc(e.station_id) + '</td><td>' + e.quantity + '</td><td>' + esc(e.reported_at) + '</td></tr>';
    }
    html += '</tbody></table>';
    document.getElementById('log-body').innerHTML = html;
  } catch(e) { document.getElementById('log-body').innerHTML = '<p style="color:red;">Error: ' + esc(String(e)) + '</p>'; }
}

function esc(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
{{end}}
