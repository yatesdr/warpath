{{define "content"}}
<div>
  <h1 class="mb-2">Configuration</h1>

  {{if .Saved}}
  <div class="alert alert-ok mb-2">Settings saved ({{.Saved}}).</div>
  {{end}}

  <!-- General (Server Identity + Fleet combined) -->
  <div class="card mb-2">
    <h3>General</h3>
    <form method="POST" action="/config/save">
      <input type="hidden" name="section" value="general">
      <div class="form-group mb-1">
        <label>Server Identity</label>
        <input type="text" name="factory_id" value="{{.Config.FactoryID}}" placeholder="Factory / site identifier">
      </div>
      <h4 class="mb-1" style="margin-top:0.75rem; border-top:1px solid var(--border); padding-top:0.75rem">Fleet Backend</h4>
      <div class="grid grid-3">
        <div class="form-group">
          <label>Base URL</label>
          <input type="text" name="fleet_base_url" value="{{.Config.RDS.BaseURL}}" placeholder="http://192.168.1.100:8088">
        </div>
        <div class="form-group">
          <label>Poll Interval</label>
          <input type="text" name="fleet_poll_interval" value="{{.Config.RDS.PollInterval}}" placeholder="5s">
        </div>
        <div class="form-group">
          <label>Timeout</label>
          <input type="text" name="fleet_timeout" value="{{.Config.RDS.Timeout}}" placeholder="10s">
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-sm">Save</button>
    </form>
  </div>

  <!-- Services (Messaging + ValKey/Redis combined) -->
  <div class="card mb-2">
    <h3>Services</h3>
    <form method="POST" action="/config/save">
      <input type="hidden" name="section" value="services">

      <!-- Messaging subsection -->
      <h4 class="mb-1">Messaging</h4>
      <div class="form-group mb-1">
        <label>Backend</label>
        <select name="msg_backend" id="cfg-msg-backend" onchange="toggleMessaging()">
          <option value="mqtt"{{if eq .Config.Messaging.Backend "mqtt"}} selected{{end}}>MQTT</option>
          <option value="kafka"{{if eq .Config.Messaging.Backend "kafka"}} selected{{end}}>Kafka</option>
        </select>
      </div>

      <div id="cfg-mqtt-fields"{{if eq .Config.Messaging.Backend "kafka"}} style="display:none"{{end}}>
        <div class="grid grid-3">
          <div class="form-group">
            <label>Broker</label>
            <input type="text" name="mqtt_broker" value="{{.Config.Messaging.MQTT.Broker}}">
          </div>
          <div class="form-group">
            <label>Port</label>
            <input type="number" name="mqtt_port" value="{{.Config.Messaging.MQTT.Port}}">
          </div>
          <div class="form-group">
            <label>Client ID</label>
            <input type="text" name="mqtt_client_id" value="{{.Config.Messaging.MQTT.ClientID}}">
          </div>
        </div>
      </div>

      <div id="cfg-kafka-fields"{{if ne .Config.Messaging.Backend "kafka"}} style="display:none"{{end}}>
        <label style="font-size:0.85rem">Brokers</label>
        <div id="kafka-broker-rows">
          {{range $i, $b := .Config.Messaging.Kafka.Brokers}}
          {{$parts := splitBroker $b}}
          <div class="flex gap-1 mb-1 kafka-broker-row">
            <input type="text" name="kafka_host_{{$i}}" value="{{index $parts 0}}" placeholder="Host" style="flex:2">
            <input type="number" name="kafka_port_{{$i}}" value="{{index $parts 1}}" placeholder="9093" style="flex:1">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeKafkaBroker(this)">-</button>
          </div>
          {{end}}
        </div>
        <button type="button" class="btn btn-sm" onclick="addKafkaBroker()" style="margin-bottom:0.5rem">+ Add Broker</button>
      </div>

      <h4 class="mb-1" style="margin-top:0.75rem; border-top:1px solid var(--border); padding-top:0.75rem">Topics</h4>
      <div class="grid grid-2">
        <div class="form-group">
          <label>Orders Topic</label>
          <input type="text" name="orders_topic" value="{{.Config.Messaging.OrdersTopic}}">
        </div>
        <div class="form-group">
          <label>Dispatch Topic Prefix</label>
          <input type="text" name="dispatch_topic_prefix" value="{{.Config.Messaging.DispatchTopicPrefix}}">
        </div>
      </div>

      <!-- ValKey (Redis) subsection -->
      <h4 class="mb-1" style="margin-top:0.75rem; border-top:1px solid var(--border); padding-top:0.75rem">ValKey (Redis)</h4>
      <div class="grid grid-3">
        <div class="form-group">
          <label>Address</label>
          <input type="text" name="redis_address" value="{{.Config.Redis.Address}}" placeholder="localhost:6379">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" name="redis_password" value="{{.Config.Redis.Password}}">
        </div>
        <div class="form-group">
          <label>DB</label>
          <input type="number" name="redis_db" value="{{.Config.Redis.DB}}">
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-sm">Save</button>
    </form>
  </div>
</div>

<script>
function toggleMessaging() {
  var backend = document.getElementById('cfg-msg-backend').value;
  document.getElementById('cfg-mqtt-fields').style.display = backend === 'mqtt' ? '' : 'none';
  document.getElementById('cfg-kafka-fields').style.display = backend === 'kafka' ? '' : 'none';
}

var kafkaBrokerIdx = {{len .Config.Messaging.Kafka.Brokers}};

function addKafkaBroker() {
  var row = document.createElement('div');
  row.className = 'flex gap-1 mb-1 kafka-broker-row';
  row.innerHTML = '<input type="text" name="kafka_host_' + kafkaBrokerIdx + '" placeholder="Host" style="flex:2">' +
    '<input type="number" name="kafka_port_' + kafkaBrokerIdx + '" placeholder="9093" value="9093" style="flex:1">' +
    '<button type="button" class="btn btn-danger btn-sm" onclick="removeKafkaBroker(this)">-</button>';
  document.getElementById('kafka-broker-rows').appendChild(row);
  kafkaBrokerIdx++;
}

function removeKafkaBroker(btn) {
  btn.parentElement.remove();
}
</script>
{{end}}
