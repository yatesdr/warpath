{{template "header" .}}

<div style="display:flex;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap">
    {{if .Lines}}
    <select class="form-input" style="width:14rem" onchange="if(this.value)window.location='?line='+this.value">
        {{range .Lines}}
        <option value="{{.ID}}" {{if eq .ID $.ActiveLineID}}selected{{end}}>{{.Name}}</option>
        {{end}}
    </select>
    {{end}}
</div>

{{if .ActiveLineID}}
<div class="card">
    <div class="card-body">
        {{if .Changeover.Active}}
        <!-- Active changeover -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem">
            <div>
                <span style="font-size:0.85rem;color:var(--color-text-muted)">Changing from</span>
                <strong>{{.Changeover.FromJobStyle}}</strong>
                <span style="font-size:0.85rem;color:var(--color-text-muted)">to</span>
                <strong>{{.Changeover.ToJobStyle}}</strong>
            </div>
            <button class="btn btn-sm btn-danger" onclick="cancelChangeover()">Cancel Changeover</button>
        </div>

        <div class="co-flow" data-state-index="{{.Changeover.StateIndex}}">
            <button class="co-step" onclick="advanceChangeover()">Move to Staging</button>
            <span class="co-arrow">&rarr;</span>
            <button class="co-step" onclick="advanceChangeover()">Finalize Counts</button>
            <span class="co-arrow">&rarr;</span>
            <button class="co-step" onclick="advanceChangeover()">Move to Line</button>
            <span class="co-arrow">&rarr;</span>
            <button class="co-step" onclick="advanceChangeover()">Auto Run</button>
        </div>

        {{else}}
        <!-- Start changeover -->
        <div style="display:flex;align-items:flex-end;gap:1rem;flex-wrap:wrap">
            <div class="form-group" style="margin-bottom:0">
                <label>From</label>
                <input type="text" id="co-from" class="form-input" value="{{.ActiveJobStyle}}" readonly style="background:var(--color-bg-muted);width:14rem">
            </div>
            <div class="form-group" style="margin-bottom:0">
                <label>To</label>
                <select id="co-to" class="form-input" style="width:14rem">
                    <option value="">-- Select --</option>
                    {{range .JobStyles}}<option value="{{.Name}}">{{.Name}}</option>{{end}}
                </select>
            </div>
            <button class="btn btn-primary" id="co-start-btn" onclick="startChangeover()" disabled>Start Changeover</button>
        </div>

        <div class="co-flow co-flow-idle" style="margin-top:1.5rem">
            <button class="co-step" disabled>Move to Staging</button>
            <span class="co-arrow">&rarr;</span>
            <button class="co-step" disabled>Finalize Counts</button>
            <span class="co-arrow">&rarr;</span>
            <button class="co-step" disabled>Move to Line</button>
            <span class="co-arrow">&rarr;</span>
            <button class="co-step" disabled>Auto Run</button>
        </div>
        {{end}}
    </div>
</div>

<!-- Status Log -->
{{if .ChangeoverLog}}
<div class="card" style="margin-top:1rem">
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>From</th>
                    <th>To</th>
                    <th>State</th>
                    <th>Detail</th>
                </tr>
            </thead>
            <tbody>
                {{range .ChangeoverLog}}
                <tr>
                    <td style="white-space:nowrap;font-size:0.8rem">{{.CreatedAt}}</td>
                    <td>{{.FromJobStyle}}</td>
                    <td>{{.ToJobStyle}}</td>
                    <td><span class="status-badge">{{.State}}</span></td>
                    <td style="font-size:0.85rem;color:var(--color-text-muted)">{{if .Detail}}{{.Detail}}{{else}}--{{end}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{end}}

{{else}}
<div class="card">
    <div class="card-body">
        <p class="empty-cell">No production lines configured</p>
    </div>
</div>
{{end}}

<style>
.co-flow {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}
.co-arrow {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    user-select: none;
}
.co-step {
    padding: 0.5rem 1.25rem;
    border: 2px solid var(--color-border);
    border-radius: 6px;
    background: var(--color-bg);
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: default;
    transition: all 0.15s;
}
.co-step.co-done {
    border-color: var(--color-success);
    background: var(--color-success);
    color: #fff;
}
.co-step.co-active {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: #fff;
    cursor: pointer;
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 25%, transparent);
}
.co-step.co-active:hover {
    filter: brightness(1.1);
}
.co-flow-idle .co-step {
    opacity: 0.5;
}
</style>

<script>
var activeLineID = {{.ActiveLineID}};

// Enable start button when a "To" style is selected
(function() {
    var toSel = document.getElementById('co-to');
    var startBtn = document.getElementById('co-start-btn');
    if (toSel && startBtn) {
        toSel.addEventListener('change', function() {
            startBtn.disabled = !this.value;
        });
    }
})();

// Style the flow chart steps based on current state
(function() {
    var flow = document.querySelector('.co-flow[data-state-index]');
    if (!flow) return;
    var idx = parseInt(flow.dataset.stateIndex);
    var steps = flow.querySelectorAll('.co-step');
    // Map state index ranges to step buttons:
    // Step 0 (Move to Staging):  states 1-2 (stopping, counting_out)
    // Step 1 (Finalize Counts):  state 3 (storing)
    // Step 2 (Move to Line):     state 4 (delivering)
    // Step 3 (Auto Run):         states 5-6 (counting_in, ready)
    var stepRanges = [[1,2],[3,3],[4,4],[5,6]];
    var activeStep = -1;
    for (var i = 0; i < stepRanges.length; i++) {
        if (idx >= stepRanges[i][0] && idx <= stepRanges[i][1]) {
            activeStep = i;
            break;
        }
    }
    for (var i = 0; i < steps.length; i++) {
        if (i < activeStep) {
            steps[i].classList.add('co-done');
        } else if (i === activeStep) {
            steps[i].classList.add('co-active');
        }
        if (i !== activeStep) {
            steps[i].disabled = true;
        }
    }
})();

async function startChangeover() {
    var fromVal = document.getElementById('co-from').value;
    var toVal = document.getElementById('co-to').value;
    if (!toVal) return;
    try {
        await ShinGoEdge.api.post('/api/changeover/start', {
            line_id: activeLineID,
            from_job_style: fromVal,
            to_job_style: toVal,
            operator: ''
        });
        ShinGoEdge.toast('Changeover started', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

async function advanceChangeover() {
    try {
        await ShinGoEdge.api.post('/api/changeover/advance', {
            line_id: activeLineID,
            operator: ''
        });
        ShinGoEdge.toast('Changeover advanced', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

async function cancelChangeover() {
    var ok = await ShinGoEdge.confirm('Cancel this changeover? The line will return to its current state.');
    if (!ok) return;
    try {
        await ShinGoEdge.api.post('/api/changeover/cancel', {
            line_id: activeLineID
        });
        ShinGoEdge.toast('Changeover cancelled', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

ShinGoEdge.createSSE('/events', {
    onChangeoverUpdate: function() { location.reload(); },
    onCounterAnomaly: function() { location.reload(); }
});
</script>

{{template "footer" .}}
