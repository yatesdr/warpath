{{template "header" .}}

<div style="display:flex;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap">
    {{if .Lines}}
    <select class="form-input" style="width:14rem" onchange="window.location=this.value?'?line='+this.value:'/kanbans'">
        <option value="" {{if eq .ActiveLineID 0}}selected{{end}}>All Lines</option>
        {{range .Lines}}
        <option value="{{.ID}}" {{if eq .ID $.ActiveLineID}}selected{{end}}>{{.Name}}</option>
        {{end}}
    </select>
    {{end}}
</div>

<div class="card">
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>Type</th>
                    <th>Line</th>
                    <th>Payload</th>
                    <th>Target</th>
                    <th>Status</th>
                    <th>ETA</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="orders-body">
                {{range .ActiveOrders}}
                <tr data-order-id="{{.ID}}">
                    <td class="tag-name">{{printf "%.8s" .UUID}}</td>
                    <td>{{.OrderType}}</td>
                    <td>{{if .LineName}}{{.LineName}}{{else}}<span style="color:var(--color-text-muted)">--</span>{{end}}</td>
                    <td>{{.PayloadDesc}}</td>
                    <td class="mono">{{.DeliveryNode}}{{if .StagingNode}} <span style="color:var(--color-text-muted);font-size:0.75rem">(stg: {{.StagingNode}})</span>{{end}}</td>
                    <td><span class="status-badge">{{.Status}}</span></td>
                    <td>{{if .ETA}}{{.ETA}}{{else}}--{{end}}</td>
                    <td class="actions">
                        {{if eq .Status "delivered"}}
                            <button class="btn btn-sm btn-primary" onclick="confirmDelivery({{.ID}}, {{.Quantity}})">Confirm</button>
                        {{end}}
                        {{if eq .Status "queued"}}
                            <button class="btn btn-sm btn-primary" onclick="submitOrder({{.ID}})">Submit</button>
                        {{end}}
                        {{if and .PayloadID (not (eq .Status "confirmed")) (not (eq .Status "cancelled"))}}
                            {{if eq .DeliveryNode .StagingNode}}
                                <button class="btn btn-sm" onclick="stageOrder({{.ID}}, '{{.PayloadLocation}}')">Move to LSL</button>
                            {{else}}
                                {{if .StagingNode}}
                                <button class="btn btn-sm" onclick="stageOrder({{.ID}}, '{{.StagingNode}}')">Stage</button>
                                {{end}}
                            {{end}}
                        {{end}}
                        {{if and (not (eq .Status "confirmed")) (not (eq .Status "cancelled"))}}
                            <div style="display:inline-block;position:relative">
                                <button class="btn btn-sm" onclick="showRedirectDropdown({{.ID}}, this)">Redirect</button>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="abortOrder({{.ID}})">Abort</button>
                        {{end}}
                    </td>
                </tr>
                {{else}}
                <tr><td colspan="8" class="empty-cell">No active orders</td></tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<!-- Redirect Modal -->
<div class="modal" id="redirect-modal" style="display:none">
    <div class="modal-content">
        <div class="card">
            <div class="modal-header">Redirect Order <button class="btn btn-sm" onclick="ShinGoEdge.hideModal('redirect-modal')">&times;</button></div>
            <div class="card-body">
                <div class="form-group">
                    <label>New Delivery Node</label>
                    <select id="redirect-node" class="form-input">
                        {{range .KnownNodes}}
                        <option value="{{.}}">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                <input type="hidden" id="redirect-order-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="ShinGoEdge.hideModal('redirect-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitRedirect()">Redirect</button>
            </div>
        </div>
    </div>
</div>

<script>
async function confirmDelivery(orderID, qty) {
    try {
        await ShinGoEdge.api.post('/api/confirm-delivery/' + orderID, { final_count: qty });
        ShinGoEdge.toast('Delivery confirmed', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

async function submitOrder(orderID) {
    try {
        await ShinGoEdge.api.post('/api/orders/' + orderID + '/submit', {});
        ShinGoEdge.toast('Order submitted', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

async function abortOrder(orderID) {
    var ok = await ShinGoEdge.confirm('Abort this order? This will cancel it and notify dispatch.');
    if (!ok) return;
    try {
        await ShinGoEdge.api.post('/api/orders/' + orderID + '/abort', {});
        ShinGoEdge.toast('Order aborted', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

async function stageOrder(orderID, node) {
    try {
        await ShinGoEdge.api.post('/api/orders/' + orderID + '/redirect', { delivery_node: node });
        ShinGoEdge.toast('Order redirected', 'success');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

function showRedirectDropdown(orderID) {
    document.getElementById('redirect-order-id').value = orderID;
    ShinGoEdge.showModal('redirect-modal');
}

async function submitRedirect() {
    var orderID = document.getElementById('redirect-order-id').value;
    var node = document.getElementById('redirect-node').value;
    try {
        await ShinGoEdge.api.post('/api/orders/' + orderID + '/redirect', { delivery_node: node });
        ShinGoEdge.toast('Order redirected', 'success');
        ShinGoEdge.hideModal('redirect-modal');
        location.reload();
    } catch (e) { ShinGoEdge.toast('Error: ' + e, 'error'); }
}

// SSE with debounce
var _reloadTimer = null;
function debouncedReload() {
    if (_reloadTimer) clearTimeout(_reloadTimer);
    _reloadTimer = setTimeout(function() { location.reload(); }, 500);
}

ShinGoEdge.createSSE('/events', {
    onOrderUpdate: function() { debouncedReload(); },
    onCounterAnomaly: function() { location.reload(); }
});
</script>

{{template "footer" .}}
