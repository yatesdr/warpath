{{template "header" .}}

<div class="page-header">
    <h1>Manual Order</h1>
</div>

<div class="card" style="max-width:600px;margin:0 auto">
    <div class="card-header"><strong>Manual Order</strong></div>
    <div class="card-body">
        <div class="form-group">
            <label>Order Type</label>
            <select id="mo-type" class="form-input" onchange="updateOrderForm()">
                <option value="retrieve">Retrieve</option>
                <option value="store">Store</option>
                <option value="move">Move</option>
            </select>
        </div>
        <div class="form-group">
            <label>Payload</label>
            <select id="mo-payload" class="form-input" onchange="autofillPayloadNodes()">
                <option value="">-- Select --</option>
                {{range .Payloads}}
                <option value="{{.ID}}" data-location="{{.Location}}" data-staging="{{.StagingNode}}" data-retrieve-empty="{{.RetrieveEmpty}}">{{.Description}} ({{.Location}})</option>
                {{end}}
            </select>
        </div>
        <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="mo-qty" class="form-input" value="1" min="1">
        </div>
        <div class="form-group" id="mo-pickup-group" style="display:none">
            <label>Pickup Node</label>
            <select id="mo-pickup" class="form-input">
                <option value="">-- Select --</option>
                {{range .Nodes}}<option value="{{.NodeID}}">{{.NodeID}}{{if .Description}} — {{.Description}}{{end}}</option>{{end}}
            </select>
        </div>
        <div class="form-group" id="mo-delivery-group">
            <label>Delivery Node</label>
            <select id="mo-delivery" class="form-input">
                <option value="">-- Select --</option>
                {{range .Nodes}}<option value="{{.NodeID}}">{{.NodeID}}{{if .Description}} — {{.Description}}{{end}}</option>{{end}}
            </select>
        </div>
        <div style="text-align:right;margin-top:0.75rem">
            <button class="btn btn-primary" onclick="createOrder()">Create Order</button>
        </div>
    </div>
</div>

<script>
function updateOrderForm() {
    var t = document.getElementById('mo-type').value;
    document.getElementById('mo-delivery-group').style.display = (t === 'retrieve' || t === 'move') ? '' : 'none';
    document.getElementById('mo-pickup-group').style.display = (t === 'store' || t === 'move') ? '' : 'none';
    autofillPayloadNodes();
}

function autofillPayloadNodes() {
    var sel = document.getElementById('mo-payload');
    var opt = sel.options[sel.selectedIndex];
    if (!opt || !opt.value) return;
    var t = document.getElementById('mo-type').value;
    if (t === 'retrieve') {
        document.getElementById('mo-delivery').value = opt.dataset.location || '';
    } else if (t === 'move') {
        document.getElementById('mo-delivery').value = '';
        document.getElementById('mo-pickup').value = opt.dataset.location || '';
    } else if (t === 'store') {
        document.getElementById('mo-pickup').value = opt.dataset.location || '';
    }
}

async function createOrder() {
    var t = document.getElementById('mo-type').value;
    var payloadID = parseInt(document.getElementById('mo-payload').value) || 0;
    var body = {
        payload_id: payloadID || null,
        quantity: parseFloat(document.getElementById('mo-qty').value),
        delivery_node: document.getElementById('mo-delivery').value,
        pickup_node: document.getElementById('mo-pickup').value
    };
    try {
        await ShingoEdge.api.post('/api/orders/' + t, body);
        ShingoEdge.toast('Order created', 'success');
        // Reset form
        document.getElementById('mo-payload').selectedIndex = 0;
        document.getElementById('mo-qty').value = '1';
        document.getElementById('mo-delivery').selectedIndex = 0;
        document.getElementById('mo-pickup').selectedIndex = 0;
    } catch (e) { ShingoEdge.toast('Error: ' + e, 'error'); }
}

ShingoEdge.createSSE('/events', {
    onCounterAnomaly: function() { location.reload(); }
});
</script>

{{template "footer" .}}
